---
layout: post
title: "KFC - Soda cup exploit - (almost) Free drinks (as before)"
description: "THIS ONLY WORKS IN FRANCE."
preview: "kfc/logo.png"
preview2x: "kfc/logo@2x.png"
previewAlt: "KFC Logo"
tags: [qrcode, exploit, diy]
---

<br />
<br />
> DISCLAIMER:<br />
> <small>Of course you shouldn't do this without buying another cup. </small>
> <br /><small>Actually you shouldn't do this at all because someone will get a non-working cup.

<br />
<br />

# Introduction

This weekend we went to KFC with a bunch of friends and we were surprised to discover that the
soda fountain was no longer at will. Not that I'm a fan of soda, but the system set up to limit
the drinks was quite surprising/complex for a fast-food.

{% include image.html path="kfc/kfc_cup.jpg" path-detail="kfc/kfc_cup@2x.jpg" alt="KFC Cup." %}

> <small><small>nb: after a little research, self-service soda fountains are now prohibited in France since January 2017</small></small>

{% include image.html path="kfc/why.jpg" path-detail="kfc/why.jpg" alt="why." %}

Now in KFCs in France you need to scan your cup in order to get it filled. Of course you can do it
only once, if you try to scan your cup again you will be denied.

As a tech guy, my first reflex was to scan the QR Code without much conviction to find something of
great interest as I expected some crypted content.

------------
<br />
# Guess what ?
<br />

```
WBCB;SERVICE;1;3005970;40
```

This is the content of the QR Code. Plain text.

The first thing that came to my mind is that:
- `40` was the _capacity in CL_ of the cup (and the amount poured into it) <br />— and I was right
- `3005970` was the ID of the cup — and I was almost right

My friends' cups ID pattern were:
- `300597x` for a _40cl_ cup
- `400xxxx` for a _50cl_ cup

Actually the cup id was the 4 last digits, the first 3 digits were related to the size of the cup.


I tried to increment my ID by __1000__. It didn't work, my QR Code did get denied. We tried to
increment it by __80__ and .. __it worked__ !

### Assumption

Maybe the KFC staff receive these cups in large boxes and they need to scan them (the boxes) in order
to activate the cups. That would explain why it did not work when we incremented the id by a thousand.

------------
<br />
# Thoughts on how to protect these cups
<br />

##### AES Encryption 256 bit
{% include image.html path="kfc/aes_solution.png" path-detail="kfc/aes_solution.png" alt="AES Encryption" %}

Encrypting the QR Code content with a 256bit private key would certainly solve this problem.
The scanner could decrypt the content without any problem nor delay.

<br />
##### Move the fountain behind the counter
{% include image.html path="kfc/counter_solution.png" path-detail="kfc/counter_solution.png" alt="Easiest solution - Move fountain + remove QR Codes." %}
... like in 95% of fast-foods. And just serve the cups filled.

<br /><br /><br />
